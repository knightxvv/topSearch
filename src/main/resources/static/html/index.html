<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>topSearch</title>
    <script type="text/javascript" src="./js/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="./js/echarts.min.js"></script>
    <script type="text/javascript" src="./js/public.js"></script>
    <style>
        *{
            box-sizing:border-box;
        }
        .searchResult{
            width:80%;
            word-wrap:break-word;
            float:left;
            border:1px solid #000;
            margin: 0 0 -1px -1px;
            cursor:pointer;
        }
        .searchResultWebsite{
            width:20%;
            word-wrap:break-word;
            float:left;
        }
        
        span.emphasis{
            color:red;
        }
    </style>
    
    <script>    
        $(function(){
        	getWebsiteList();
        	getLatest($('#websiteSelect').val());
        	searchdate();
        	$('.website').click(function(){
        		var target=$(this).attr('target');
        		$.ajax({
        			url:contextPath+'/website/parse/'+target,
        			type:'get',
        			dataType:'text',
        			async:true,
        			success:function(data){
        				alert(data)
//                         $(JSON.parse(data)).each(function(i,x){
//                         	$('.main').append(x+'<br>');
//                         })
        				
        			},error:function(data){
//         				alert(JSON.stringify(data))
        			}
        		})
        	})
        	$('#websiteSelect').change(function(){
        		var website=$(this).val();
        		getLatest(website);
        		searchdate();
        	})
        	$('#websiteSelectCount').change(function(){
                var website=$('#websiteSelect').val();
                getLatest(website);
                searchdate();
            })
            $(document).on('click','.searchResult',function(){
                var title=$(this).text();
                var website=$(this).next().text();
                searchByTitle(title,website);
            })
        });
        
        function getWebsiteList(){

        	$.ajax({
                url:contextPath+'/website/get/allWebsite/',
                type:'get',
                dataType:'text',
                async:false,
                success:function(data){
//                  alert(data)
                    var html="";
                    $(JSON.parse(data)).each(function(i,x){
                        html+='<option value="'+x.website+'">'+x.website+'</option>';
                    })
                    $('#websiteSelect').html(html);
                    
                },error:function(data){
//                  alert(JSON.stringify(data))
                }
            })
        }
        
        function getLatest(website){
//         	var website=$('.gc').attr('target');
            var chooseCount="";
            if($('#websiteSelectCount').val()!=0){
                chooseCount=$('#websiteSelectCount').val();
            }
        	$.ajax({
                url:contextPath+'/hotSearch/'+website+'/latest/'+chooseCount,
                type:'get',
                dataType:'text',
                async:false,
                success:function(data){
//                 	alert(data)
                    var myChart = echarts.init(document.getElementById('chart1'));
                    var x=[],y=[],z=[];
                    var time;
                    $(JSON.parse(data)).each(function(i,item){
                    	time=item.time;
                    	x.push(item.title);
                    	y.push(item.score);
                    	z.push(item.ranking);
                    })
                    // 指定图表的配置项和数据
                    var option = {
                    		title: {
                                text: website+":"+time
                            },
                            tooltip:{
                            	trigger: "axis",
                                formatter: function(params) {
//                                     console.log(JSON.stringify(params))
                                    var res="";
                                    res+="排名:"+params[0].name+"<br>热度:"+params[0].data+"<br>主题:"+x[params[0].name-1];
//                                     return '<div style="width:100px;overflow-y:auto;">'+res+'</div>';
                                    return res;
                                },
                                axisPointer: {
                                    type: 'line'
                                },
//                                 extraCssText:'width:100px;'
                            },
                    	    xAxis: {
                    	        type: 'value',
//                     	        data: y
                    	    },
                    	    yAxis: {
                    	        type: 'category',
//                     	        name:'排名',
                    	        data:z,
                    	        inverse: true,
                    	        interval:1,
                    	        axisTick: {show: false},
                    	    },
                    	    series: [{
                    	        data: y,
                    	        type: 'bar',
//                     	        name:'排名',
                                label: {
                                	normal: {
                                        show: true, //开启显示
                                        position: 'right', //在上方显示
                                        textStyle: { //数值样式
                                            color: 'black',
                                            fontSize: 3
                                        }
                                    }
                                }
                            }]
                    	};
                    myChart.setOption(option,true);
                    
                },error:function(data){
//                  alert(JSON.stringify(data))
                }
            })
        }
        	
        function search(){
        	var keyword=$('.keyword').val();
        	if(keyword=="") return;
        	$.ajax({
                url:contextPath+'/hotSearch/search/'+keyword,
                type:'get',
                dataType:'text',
                async:false,
                success:function(data){
//                  alert(data)
                    var html="";
                    $(JSON.parse(data)).each(function(i,x){
                    	var tmp=x.title.replace(new RegExp(keyword,"gm"),'<span class="emphasis">'+keyword+'</span>')
                        html+='<div class="searchResult">'+tmp+'</div>'+'<div class="searchResultWebsite">'+x.website+'</div>';
                    })
                    $('.left').html(html);
                }
            })
    	}
        
        function searchByTitle(title,website){
        	$.ajax({
                url:contextPath+'/hotSearch/search/title/',
                data:{title:title,website:website},
                type:'get',
                dataType:'text',
                async:false,
                success:function(data){
//                     alert(data)
                    var myChart = echarts.init(document.getElementById('chart2'));
                    var x=[],y=[],z=[];
                    $(JSON.parse(data)).each(function(i,item){
                        x.push(item.score);
                        y.push(item.ranking);
                        z.push(item.time);
                    })
                    // 指定图表的配置项和数据
                    var option = {
                            title: {
                                text: website+"  "+title
                            },
                            tooltip:{
                                trigger: "axis",
                                axisPointer: {
                                    type: 'line'
                                },
                            },
                            xAxis: {
                            	type: 'category',
                                data:z,
                                axisTick: {show: false},
                            },
                            yAxis: [{
                            	type: 'value',
                            	name:'热度'
                            },{
                                type: 'value',
                                name:'排名',
                                min: 0,
                                max: 100,
                                interval: 10,
                                inverse:true
                            }],
                            series: [{
                                data: x,
                                type: 'line',
                                name:'热度',
                                yAxisIndex: 0,
                                label: {
                                    normal: {
                                        show: true, //开启显示
                                        position: 'top', //在上方显示
                                        textStyle: { //数值样式
                                            color: 'black',
                                            fontSize: 3
                                        }
                                    }
                                }
                            },{
                                data: y,
                                type: 'line',
                                name:'排名',
                                yAxisIndex: 1,
                                label: {
                                    normal: {
                                        show: true, //开启显示
                                        position: 'top', //在上方显示
                                        textStyle: { //数值样式
                                            color: 'black',
                                            fontSize: 3
                                        }
                                    }
                                }
                            }]
                        };
                    myChart.setOption(option,true);
                }
            })
        }
        
        function searchdate(){
        	var date=$('.date').val();
        	var website=$('#websiteSelect').val();
        	var topN=$('#websiteSelectCount').val();
        	if(topN==0) topN=3;
        	var timelist="";
        	$.ajax({
                url:contextPath+'/hotSearch/get/timelist',
                type:'get',
                data:{date:date,website:website},
                dataType:'text',
                async:false,
                success:function(data){
//                 	alert(data)
                    timelist=JSON.parse(data)
                }
            })
            $.ajax({
                url:contextPath+'/hotSearch/search/date',
                type:'get',
                data:{date:date,website:website,topN:topN},
                dataType:'text',
                async:false,
                success:function(data){
//                 	alert(data)
                	var myChart = echarts.init(document.getElementById('chart3'));
                    var multiseries=[];
                    var legend=[];
                    $(JSON.parse(data)).each(function(i,item){
                    	var x=[];
                    	legend.push('排名'+(i+1))
                    	$(item).each(function(j,sin){
                            x.push(sin.score);
                        })
                        multiseries.push({
                            data: x,
                            type: 'line',
                            name:'排名'+(i+1),
                        });
                    })
//                     console.log(multiseries.length)
                    // 指定图表的配置项和数据
                    var option = {
                            title: {
                                text: ""
                            },
                            tooltip:{
                                trigger: "axis",
                                axisPointer: {
                                    type: 'line'
                                },
                                formatter: function (params,ticket,callback) {
//                                 	console.log(JSON.stringify(params))
                                	var res="";
                                	res+=params[0].name+'<br>';
                                	$(params).each(function(i,x){
                                		res+=x.marker+x.seriesName+":"+x.data+'<br>';
                                	})
                                	
                                	var index=params[0].dataIndex;
                                	var html="";
                                	$(JSON.parse(data)).each(function(i,item){
                                        html+="排名"+item[index].ranking+"<br>"+item[index].title+'<br><br>';
                                    })
//                                     console.log(html)
                                    $('#titlelist').html(html);
                                	return res;
                                }
                            },
                            legend:{
                            	data:legend
                            },
                            xAxis: {
                                type: 'category',
                                data:timelist,
                                axisTick: {show: false},
                                triggerEvent: true,
                            },
                            yAxis: [{
                                type: 'value',
                                name:'热度'
                            }],
                            series: multiseries
                        };
                    myChart.setOption(option,true);
                }
            })
        }
        
    </script>
</head>
<body>
    <div>
        <input class="website" type="button" value="知乎" target="zhihu" onclick="">
        <input class="website" type="button" value="百度" target="baidu" onclick="">
        <input class="website" type="button" value="微博" target="weibo" onclick="">
        <input class="website" type="button" value="B站" target="bilibili" onclick="">
        <input class="website" type="button" value="贴吧" target="tieba" onclick="">
        <input class="website" type="button" value="抖音" target="douyin" onclick="">
        <input class="website" type="button" value="头条" target="toutiao" onclick="">
        <select id="websiteSelect">
        </select>
        <select id="websiteSelectCount">
            <option value='0'>0</option>
            <option value='1'>1</option>
            <option value='3'>3</option>
            <option value='5'>5</option>
            <option value='10'>10</option>
            <option value='20'>20</option>
        </select>
        <input class="date" type="text" value="2020-05-09" onclick="">
        <input class="searchdate" type="button" onclick="searchdate()" value="搜索">
    </div>    
    <div style='width:100%;height:540px;float:left;box-sizing:border-box;overflow:auto;'>
        <div id='chart3' style="width:40%;height:540px;float:left;border:1px solid #000;box-sizing:border-box;overflow:auto;">
        
        </div>
        
        <div id="titlelist" style='width:20%;height:540px;border:1px solid #000;float:left;box-sizing:border-box;overflow:auto;'>
        
        </div>
        
        <div id="chart1" style="width: 40%;height:540px;border:1px solid #000;float:left;position:relative;box-sizing:border-box;">
        </div>
    </div>
    
    
    
    <div style="margin:10px 0 10px 0;width:100%;height:20px;float:left;">
        <input class="keyword" type="text" onclick="">
        <input class="search" type="button" onclick="search()" value="搜索">
    </div>   
    <div style='width:100%;height:540px;float:left;box-sizing:border-box;overflow:auto;'>
        <div class='left' style="width:500px;height:540px;float:left;border:1px solid #000;box-sizing:border-box;overflow:auto;">
        
        </div>
        <div class='right' id="chart2" style="width: 1000px;height:540px;border:1px solid #000;float:left;position:relative;box-sizing:border-box;">
        </div>
    </div>

</body>
</html>